<h1 class="text-3xl font-bold text-gray-800 mb-6">{{ isEditMode ? 'Edit Order' : 'Create New Order' }}</h1>

<form [formGroup]="orderForm" (ngSubmit)="onSubmit()" class="space-y-6">
  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-md border">
    <div>
      <label class="block text-sm font-medium text-gray-500">Order No.</label>
      <p class="mt-1 text-lg font-bold text-gray-900">#{{ orderNo() }}</p>
    </div>
     <div>
      <label class="block text-sm font-medium text-gray-500">Order Token</label>
      <p class="mt-1 text-lg font-bold text-indigo-600 font-mono">{{ orderToken() }}</p>
    </div>
  </div>
  
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Customer Name -->
    <div>
      <label for="customerName" class="block text-sm font-medium text-gray-700">Customer Name</label>
      <input
        id="customerName"
        type="text"
        formControlName="customerName"
        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
        placeholder="e.g., Alice Johnson"
      >
      @if (formControl['customerName'].invalid && (formControl['customerName'].dirty || formControl['customerName'].touched)) {
        <p class="mt-1 text-sm text-red-600">Customer Name is required.</p>
      }
    </div>

    <!-- Contact No -->
    <div>
       <label for="contactNo" class="block text-sm font-medium text-gray-700 flex items-center justify-between">
        <span>Contact No.</span>
        @if (isRegularCustomer()) {
           <span class="px-2 py-0.5 text-xs font-semibold text-green-800 bg-green-200 rounded-full">Regular Customer</span>
        }
      </label>
      <input
        id="contactNo"
        type="text"
        formControlName="contactNo"
        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
        placeholder="10-digit mobile number"
      >
      @if (formControl['contactNo'].invalid && (formControl['contactNo'].dirty || formControl['contactNo'].touched)) {
        <p class="mt-1 text-sm text-red-600">A valid 10-digit contact number is required.</p>
      }
    </div>
  </div>


  <!-- Job Description -->
  <div>
    <label for="jobDescription" class="block text-sm font-medium text-gray-700">Job Description</label>
    <textarea
      id="jobDescription"
      formControlName="jobDescription"
      rows="3"
      class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
      placeholder="e.g., 100 A4 color prints, single-sided, glossy paper. 5 spiral bindings."
    ></textarea>
    @if (formControl['jobDescription'].invalid && (formControl['jobDescription'].dirty || formControl['jobDescription'].touched)) {
      <p class="mt-1 text-sm text-red-600">Job Description is required.</p>
    }
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Quantity -->
    <div>
      <label for="quantity" class="block text-sm font-medium text-gray-700">Quantity</label>
      <input
        id="quantity"
        type="number"
        formControlName="quantity"
        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
      >
      @if (formControl['quantity'].invalid && (formControl['quantity'].dirty || formControl['quantity'].touched)) {
        <p class="mt-1 text-sm text-red-600">Quantity must be a positive number.</p>
      }
    </div>

    <!-- Unit Price -->
    <div>
      <label for="unitPrice" class="block text-sm font-medium text-gray-700">Unit Price</label>
      <input
        id="unitPrice"
        type="number"
        step="0.01"
        formControlName="unitPrice"
        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
      >
      @if (formControl['unitPrice'].invalid && (formControl['unitPrice'].dirty || formControl['unitPrice'].touched)) {
        <p class="mt-1 text-sm text-red-600">Unit Price must be a non-negative number.</p>
      }
    </div>

     <!-- Job Urgency -->
    <div>
      <label for="jobUrgency" class="block text-sm font-medium text-gray-700">Job Urgency</label>
      <select
        id="jobUrgency"
        formControlName="jobUrgency"
        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
      >
        <option value="Normal">Normal</option>
        <option value="High">High</option>
        <option value="Urgent">Urgent</option>
      </select>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Total Amount (Calculated) -->
    <div>
      <label class="block text-sm font-medium text-gray-700">Total Amount</label>
      <p class="mt-1 block w-full px-3 py-2 border border-gray-300 bg-gray-50 rounded-md shadow-sm sm:text-lg font-semibold text-gray-900">
        {{ calculateTotalAmount() | currency:'INR':'symbol-narrow':'1.2-2' }}
      </p>
    </div>
    
     <!-- Advance Amount -->
    <div>
      <label for="advanceAmount" class="block text-sm font-medium text-gray-700">Advance Amount</label>
      <input
        id="advanceAmount"
        type="number"
        step="0.01"
        formControlName="advanceAmount"
        class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm"
      >
       @if (formControl['advanceAmount'].invalid && (formControl['advanceAmount'].dirty || formControl['advanceAmount'].touched)) {
        <p class="mt-1 text-sm text-red-600">Advance Amount must be a non-negative number.</p>
      }
    </div>
  </div>


  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Status -->
    <div>
      <label for="status" class="block text-sm font-medium text-gray-700">Status</label>
      <select
        id="status"
        formControlName="status"
        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
      >
        <option value="Pending">Pending</option>
        <option value="In Progress">In Progress</option>
        <option value="Hold">On Hold</option>
        <option value="Completed">Completed</option>
      </select>
    </div>

    <!-- Payment Status -->
    <div>
      <label for="paymentStatus" class="block text-sm font-medium text-gray-700">Payment Status</label>
      <select
        id="paymentStatus"
        formControlName="paymentStatus"
        class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
      >
        <option value="Pending">Pending</option>
        <option value="Paid">Paid</option>
      </select>
    </div>
  </div>

  <!-- Assigned To -->
  <div>
    <label for="assignedToUserId" class="block text-sm font-medium text-gray-700">Assigned To</label>
    <select
      id="assignedToUserId"
      formControlName="assignedToUserId"
      class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md"
    >
      <option value="">Unassigned</option>
      @for (user of users(); track user.id) {
        @if (user.role === 'Staff' || user.role === 'Admin') {
          <option [value]="user.id">{{ user.name }} ({{user.role}})</option>
        }
      }
    </select>
  </div>

  <div class="flex justify-end space-x-4">
    <button
      type="button"
      routerLink="/orders"
      class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
    >
      Cancel
    </button>
    <button
      type="submit"
      [disabled]="orderForm.invalid || isSaving()"
      class="inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50 disabled:cursor-not-allowed w-32"
    >
      @if (isSaving()) {
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Saving...
      } @else {
        <span>{{ isEditMode ? 'Update Order' : 'Create Order' }}</span>
      }
    </button>
  </div>
</form>